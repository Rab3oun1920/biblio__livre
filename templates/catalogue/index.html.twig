{% extends 'base.html.twig' %}

{% block title %}Catalogue - BookCollection{% endblock %}

{% block body %}
    <div class="container-fluid py-4">
        {# =========== DASHBOARD UTILISATEUR =========== #}
        {% if app.user and stats is defined %}
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card shadow-lg border-0">
                        <div class="card-header bg-primary text-white py-3">
                            <h3 class="mb-0">
                                <i class="bi bi-speedometer2"></i> Mon Tableau de Bord
                                <small class="float-end">Bienvenue, {{ app.user.prenom }} !</small>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Panier -->
                                <div class="col-md-3 mb-3">
                                    <div class="card h-100 border-start border-4 border-warning">
                                        <div class="card-body text-center">
                                            <h1 class="display-4 text-warning">
                                                <i class="bi bi-cart3"></i> {{ stats.panier_count }}
                                            </h1>
                                            <h5 class="card-title">Articles dans le panier</h5>
                                            <p class="card-text">{{ stats.panier_total|number_format(2, ',', ' ') }} TND</p>
                                            {% if stats.panier_count > 0 %}
                                                <a href="{{ path('app_panier_index') }}" class="btn btn-warning">
                                                    <i class="bi bi-arrow-right"></i> Voir mon panier
                                                </a>
                                            {% else %}
                                                <a href="#livres" class="btn btn-outline-warning">
                                                    <i class="bi bi-cart-plus"></i> Ajouter des livres
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Commandes validées -->
                                <div class="col-md-3 mb-3">
                                    <div class="card h-100 border-start border-4 border-success">
                                        <div class="card-body text-center">
                                            <h1 class="display-4 text-success">
                                                <i class="bi bi-check-circle"></i> {{ stats.commandes_validees }}
                                            </h1>
                                            <h5 class="card-title">Commandes validées</h5>
                                            <p class="card-text">Sur {{ stats.commandes_total }} au total</p>
                                            {% if stats.commandes_total > 0 %}
                                                <a href="{{ path('app_mes_commandes') }}" class="btn btn-success">
                                                    <i class="bi bi-box-seam"></i> Mes commandes
                                                </a>
                                            {% else %}
                                                <span class="badge bg-secondary">Aucune commande</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Réclamations en attente -->
                                <div class="col-md-3 mb-3">
                                    <div class="card h-100 border-start border-4 border-danger">
                                        <div class="card-body text-center">
                                            <h1 class="display-4 text-danger">
                                                <i class="bi bi-exclamation-triangle"></i> {{ stats.reclamations_en_attente }}
                                            </h1>
                                            <h5 class="card-title">Réclamations en attente</h5>
                                            <p class="card-text">En attente de réponse</p>
                                            <a href="{{ path('app_mes_reclamations') }}" class="btn btn-danger">
                                                <i class="bi bi-chat-dots"></i> Mes réclamations
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dernière commande -->
                                <div class="col-md-3 mb-3">
                                    <div class="card h-100 border-start border-4 border-info">
                                        <div class="card-body text-center">
                                            {% if stats.derniere_commande %}
                                                <h1 class="display-4 text-info">
                                                    <i class="bi bi-clock-history"></i>
                                                </h1>
                                                <h5 class="card-title">Dernière commande</h5>
                                                <p class="card-text">
                                                    <small>Le {{ stats.derniere_commande.dateCommande|date('d/m/Y') }}</small><br>
                                                    <strong>{{ stats.derniere_commande.montantTotal|number_format(2, ',', ' ') }} TND</strong>
                                                </p>
                                                <a href="{{ path('app_commande_show', {'id': stats.derniere_commande.id}) }}" class="btn btn-info">
                                                    <i class="bi bi-eye"></i> Voir détails
                                                </a>
                                            {% else %}
                                                <h1 class="display-4 text-info">
                                                    <i class="bi bi-bag-plus"></i>
                                                </h1>
                                                <h5 class="card-title">Première commande</h5>
                                                <p class="card-text">Vous n'avez pas encore passé de commande</p>
                                                <a href="#livres" class="btn btn-outline-info">
                                                    <i class="bi bi-shop"></i> Découvrir le catalogue
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        {# =========== FIN DASHBOARD =========== #}

        <!-- Titre Catalogue -->
        <div class="row mb-4" id="livres">
            <div class="col-md-12">
                <h2><i class="bi bi-grid-3x3-gap-fill"></i> Catalogue de Livres</h2>
                <p class="text-muted">Découvrez notre collection de {{ livres|length }} livre(s)</p>
            </div>
        </div>

        {# Filtres et Recherche #}
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Rechercher et Filtrer</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3" action="{{ path('app_catalogue') }}">
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-search"></i> Recherche</label>
                        <input type="text" name="q" class="form-control" value="{{ filtres.recherche }}" placeholder="Titre du livre...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-person"></i> Auteur</label>
                        <select name="auteur" class="form-select">
                            <option value="">Tous les auteurs</option>
                            {% for auteur in auteurs %}
                                <option value="{{ auteur.id }}" {% if filtres.auteur == auteur.id %}selected{% endif %}>
                                    {{ auteur.prenom }} {{ auteur.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-bookmark"></i> Genre</label>
                        <select name="genre" class="form-select">
                            <option value="">Tous les genres</option>
                            {% for genre in genres %}
                                <option value="{{ genre }}" {% if filtres.genre == genre %}selected{% endif %}>{{ genre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-sort-down"></i> Trier par</label>
                        <select name="tri" class="form-select">
                            <option value="recent" {% if filtres.tri == 'recent' %}selected{% endif %}>Plus récent</option>
                            <option value="prix_asc" {% if filtres.tri == 'prix_asc' %}selected{% endif %}>Prix croissant</option>
                            <option value="prix_desc" {% if filtres.tri == 'prix_desc' %}selected{% endif %}>Prix décroissant</option>
                            <option value="titre" {% if filtres.tri == 'titre' %}selected{% endif %}>Titre A-Z</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel"></i> Appliquer les filtres
                        </button>
                        <a href="{{ path('app_catalogue') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Réinitialiser
                        </a>
                    </div>
                </form>
            </div>
        </div>

        {# Grille de Livres #}
        {% if livres is empty %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Aucun livre trouvé avec ces critères.
                <a href="{{ path('app_catalogue') }}" class="alert-link">Réinitialiser les filtres</a>
            </div>
        {% else %}
            <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
                {% for livre in livres %}
                    <div class="col">
                        <div class="card card-livre h-100 shadow-sm">
                            {% if livre.imageCouverture %}
                                <img src="{{ asset('uploads/livres/' ~ livre.imageCouverture) }}"
                                     class="card-img-top livre-image"
                                     alt="{{ livre.titre }}">
                            {% else %}
                                <div class="livre-image bg-secondary d-flex align-items-center justify-content-center">
                                    <i class="bi bi-book fs-1 text-white"></i>
                                </div>
                            {% endif %}

                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">{{ livre.titre|length > 30 ? livre.titre|slice(0, 30) ~ '...' : livre.titre }}</h5>
                                <p class="card-text text-muted small mb-2">
                                    <i class="bi bi-person"></i> {{ livre.auteur.prenom }} {{ livre.auteur.nom }}
                                </p>

                                {% if livre.genre %}
                                    <span class="badge bg-info mb-2">{{ livre.genre }}</span>
                                {% endif %}

                                {# Note moyenne #}
                                {% if livre.getMoyenneNotes() is defined and livre.getMoyenneNotes() > 0 %}
                                    <div class="mb-2">
                                        {% set moyenne = livre.getMoyenneNotes() %}
                                        {% for i in 1..5 %}
                                            {% if i <= moyenne %}
                                                <i class="bi bi-star-fill etoiles"></i>
                                            {% else %}
                                                <i class="bi bi-star etoiles"></i>
                                            {% endif %}
                                        {% endfor %}
                                        <small class="text-muted">({{ moyenne|number_format(1) }})</small>
                                    </div>
                                {% endif %}

                                <div class="mt-auto">
                                    <p class="fs-4 text-primary fw-bold mb-2">{{ livre.prix|number_format(2, ',', ' ') }} TND</p>

                                    {% if livre.stock > 0 %}
                                        <span class="badge bg-success mb-2">
                                        <i class="bi bi-check-circle"></i> En stock ({{ livre.stock }})
                                    </span>
                                    {% else %}
                                        <span class="badge bg-danger mb-2">
                                        <i class="bi bi-x-circle"></i> Rupture de stock
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="card-footer bg-transparent border-top-0">
                                <div class="d-grid gap-2">
                                    <a href="{{ path('app_catalogue_show', {id: livre.id}) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye"></i> Voir détails
                                    </a>
                                    {% if app.user and livre.stock > 0 %}
                                        <a href="{{ path('app_panier_ajouter', {id: livre.id}) }}" class="btn btn-primary btn-sm">
                                            <i class="bi bi-cart-plus"></i> Ajouter au panier
                                        </a>
                                    {% elseif not app.user %}
                                        <a href="{{ path('app_login') }}" class="btn btn-secondary btn-sm">
                                            <i class="bi bi-lock"></i> Connectez-vous
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block stylesheets %}
    <style>
        /* Style pour le dashboard */
        .border-start {
            border-left-width: 5px !important;
        }

        /* Style pour les cartes du dashboard */
        .card.h-100:hover {
            transform: translateY(-5px);
            transition: transform 0.3s;
        }

        /* Style pour les cartes livres */
        .card-livre {
            transition: transform 0.3s;
        }
        .card-livre:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }
        .livre-image {
            height: 200px;
            object-fit: cover;
        }

        /* Étoiles pour les notes */
        .etoiles {
            color: #ffc107;
        }

        /* Style pour le conteneur */
        .container-fluid {
            max-width: 1400px;
        }
    </style>
{% endblock %}
